// @vitest-environment jsdom
/* eslint-disable @next/next/no-img-element, jsx-a11y/alt-text */
import type { ImgHTMLAttributes, ReactNode } from "react";
import { afterEach, describe, expect, it, vi } from "vitest";
import { fireEvent, render, screen, waitFor, within } from "@testing-library/react";

import TripDetail from "../../src/components/trips/trip-detail";
import { LocaleProvider } from "../../src/utils/locale-context";

vi.mock("next/image", () => ({
  default: (props: ImgHTMLAttributes<HTMLImageElement>) => <img {...props} />,
}));

vi.mock("next/link", () => ({
  default: ({ href, children }: { href: string; children: ReactNode }) => (
    <a href={href}>{children}</a>
  ),
}));

vi.mock("next/navigation", () => ({
  useRouter: () => ({
    push: vi.fn(),
    refresh: vi.fn(),
  }),
}));

const renderWithProvider = (component: React.ReactElement) => {
  return render(<LocaleProvider>{component}</LocaleProvider>);
};

// Helper to create overview response mock
const createOverviewMock = (tripId: string, entries: unknown[] = []) => {
  return new Response(
    JSON.stringify({
      data: {
        trip: {
          id: tripId,
          title: "Italy Highlights",
          startDate: "2025-05-01T00:00:00.000Z",
          endDate: "2025-05-10T00:00:00.000Z",
          coverImageUrl: null,
        },
        entries,
      },
      error: null,
    }),
    { status: 200 },
  );
};

describe("TripDetail share panel", () => {
  afterEach(() => {
    vi.unstubAllGlobals();
  });

  it("renders share control in the header near the owner label", async () => {
    const fetchMock = vi
      .fn()
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: {
              id: "trip-1",
              title: "Italy Highlights",
              startDate: "2025-05-01T00:00:00.000Z",
              endDate: "2025-05-10T00:00:00.000Z",
              coverImageUrl: null,
            },
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: [],
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(createOverviewMock("trip-1"))
      .mockResolvedValueOnce(new Response(null, { status: 404 }));

    vi.stubGlobal("fetch", fetchMock);

    renderWithProvider(<TripDetail tripId="trip-1" canAddEntry canEditTrip canDeleteTrip canManageShare canManageViewers />);

    const ownerLabel = await screen.findByText(/owner:/i);
    const headerSection = ownerLabel.closest("section");
    expect(headerSection).not.toBeNull();

    if (!headerSection) {
      return;
    }

    expect(
      within(headerSection).getByRole("button", { name: /share trip/i }),
    ).toBeInTheDocument();
  });

  it("renders share link and copies it", async () => {
    const shareUrl = "http://localhost/trips/share/test-token";
    const viewersResponse = [
      {
        id: "access-1",
        tripId: "trip-1",
        userId: "viewer-1",
        canContribute: false,
        createdAt: "2025-05-01T00:00:00.000Z",
        user: {
          id: "viewer-1",
          name: "Jamie Viewer",
          email: "viewer@example.com",
        },
      },
    ];
    const fetchMock = vi
      .fn()
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: {
              id: "trip-1",
              title: "Italy Highlights",
              startDate: "2025-05-01T00:00:00.000Z",
              endDate: "2025-05-10T00:00:00.000Z",
              coverImageUrl: null,
            },
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: [],
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(new Response(null, { status: 404 }))
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: viewersResponse,
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: [],
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: {
              shareUrl,
              token: "test-token",
              tripId: "trip-1",
            },
            error: null,
          }),
          { status: 200 },
        ),
      );

    const writeText = vi.fn().mockResolvedValue(undefined);
    vi.stubGlobal("navigator", {
      clipboard: {
        writeText,
      },
    });
    vi.stubGlobal("fetch", fetchMock);

    renderWithProvider(<TripDetail tripId="trip-1" canAddEntry canEditTrip canDeleteTrip canManageShare canManageViewers />);

    const shareTrigger = await screen.findByRole("button", {
      name: /share trip/i,
    });
    fireEvent.click(shareTrigger);

    const createButton = await screen.findByRole("button", {
      name: /generate link/i,
    });
    fireEvent.click(createButton);

    const shareInput = await screen.findByLabelText("Share URL");
    expect(shareInput).toHaveValue(shareUrl);

    fireEvent.click(
      screen.getByRole("button", { name: /copy link/i }),
    );

    expect(writeText).toHaveBeenCalledWith(shareUrl);
  });

  it("shows an existing share link without regenerate action", async () => {
    const shareUrl = "http://localhost/trips/share/existing-token";
    const viewersResponse = [
      {
        id: "access-1",
        tripId: "trip-1",
        userId: "viewer-1",
        canContribute: false,
        createdAt: "2025-05-01T00:00:00.000Z",
        user: {
          id: "viewer-1",
          name: "Jamie Viewer",
          email: "viewer@example.com",
        },
      },
    ];
    const fetchMock = vi
      .fn()
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: {
              id: "trip-1",
              title: "Italy Highlights",
              startDate: "2025-05-01T00:00:00.000Z",
              endDate: "2025-05-10T00:00:00.000Z",
              coverImageUrl: null,
            },
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: [],
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: {
              shareUrl,
              token: "existing-token",
              tripId: "trip-1",
            },
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: viewersResponse,
            error: null,
          }),
          { status: 200 },
        ),
      );
    fetchMock.mockResolvedValueOnce(
      new Response(
        JSON.stringify({
          data: [],
          error: null,
        }),
        { status: 200 },
      ),
    );

    vi.stubGlobal("fetch", fetchMock);

    renderWithProvider(<TripDetail tripId="trip-1" canAddEntry canEditTrip canDeleteTrip canManageShare canManageViewers />);

    const shareTrigger = await screen.findByRole("button", {
      name: /share trip/i,
    });
    fireEvent.click(shareTrigger);

    const shareInput = await screen.findByDisplayValue(shareUrl);
    expect(shareInput).toHaveValue(shareUrl);
    expect(
      screen.queryByRole("button", { name: /regenerate link/i }),
    ).toBeNull();
  });

  it("revokes a share link from the Trip Actions area", async () => {
    const shareUrl = "http://localhost/trips/share/existing-token";
    const viewersResponse = [];
    const fetchMock = vi
      .fn()
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: {
              id: "trip-1",
              title: "Italy Highlights",
              startDate: "2025-05-01T00:00:00.000Z",
              endDate: "2025-05-10T00:00:00.000Z",
              coverImageUrl: null,
            },
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: [],
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: {
              shareUrl,
              token: "existing-token",
              tripId: "trip-1",
            },
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: {
              revoked: true,
              tripId: "trip-1",
            },
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: viewersResponse,
            error: null,
          }),
          { status: 200 },
        ),
      );
    fetchMock.mockResolvedValueOnce(
      new Response(
        JSON.stringify({
          data: [],
          error: null,
        }),
        { status: 200 },
      ),
    );

    vi.stubGlobal("fetch", fetchMock);

    renderWithProvider(<TripDetail tripId="trip-1" canAddEntry canEditTrip canDeleteTrip canManageShare canManageViewers />);

    const actionsHeader = await screen.findByText(/trip actions/i);
    const actionsSection = actionsHeader.closest("section");
    expect(actionsSection).not.toBeNull();

    if (!actionsSection) {
      return;
    }

    const revokeButton = within(actionsSection).getByRole("button", {
      name: /revoke share link/i,
    });
    fireEvent.click(revokeButton);

    const confirmButton = await screen.findByRole("button", {
      name: /yes, revoke/i,
    });
    fireEvent.click(confirmButton);

    const shareTrigger = await screen.findByRole("button", {
      name: /share trip/i,
    });
    fireEvent.click(shareTrigger);

    await screen.findByText(/link revoked/i);
    expect(screen.queryByLabelText("Share URL")).toBeNull();
  });

  it("lists invited viewers and sends an invite", async () => {
    const eligibleResponse = [
      {
        id: "viewer-2",
        name: "Riley Guest",
        email: "riley@example.com",
        role: "viewer",
        createdAt: "2025-05-02T00:00:00.000Z",
        updatedAt: "2025-05-02T00:00:00.000Z",
      },
    ];
    const fetchMock = vi
      .fn()
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: {
              id: "trip-1",
              title: "Italy Highlights",
              startDate: "2025-05-01T00:00:00.000Z",
              endDate: "2025-05-10T00:00:00.000Z",
              coverImageUrl: null,
            },
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: [],
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(new Response(null, { status: 404 }))
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: [
              {
                id: "access-1",
                tripId: "trip-1",
                userId: "viewer-1",
                canContribute: false,
                createdAt: "2025-05-01T00:00:00.000Z",
                user: {
                  id: "viewer-1",
                  name: "Jamie Viewer",
                  email: "viewer@example.com",
                },
              },
            ],
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: eligibleResponse,
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: {
              id: "access-2",
              tripId: "trip-1",
              userId: "viewer-2",
              canContribute: false,
              createdAt: "2025-05-02T00:00:00.000Z",
              user: {
                id: "viewer-2",
                name: "Riley Guest",
                email: "riley@example.com",
              },
            },
            error: null,
          }),
          { status: 201 },
        ),
      );

    vi.stubGlobal("fetch", fetchMock);

    renderWithProvider(<TripDetail tripId="trip-1" canAddEntry canEditTrip canDeleteTrip canManageShare canManageViewers />);

    const shareTrigger = await screen.findByRole("button", {
      name: /share trip/i,
    });
    fireEvent.click(shareTrigger);

    await screen.findByText("Jamie Viewer");
    expect(screen.getByText("viewer@example.com")).toBeInTheDocument();
    const inviteSelect = await screen.findByLabelText("Invite viewer selector");
    fireEvent.click(inviteSelect);
    const inviteOption = await screen.findByRole("option", {
      name: /riley guest/i,
    });
    fireEvent.click(inviteOption);

    fireEvent.click(screen.getByRole("button", { name: /^invite$/i }));

    await screen.findByText("Riley Guest");
    expect(screen.getByText("riley@example.com")).toBeInTheDocument();
    expect(inviteSelect).toHaveTextContent(/no eligible users/i);
  });

  it("toggles contributor access with optimistic updates", async () => {
    const viewersResponse = [
      {
        id: "access-1",
        tripId: "trip-1",
        userId: "viewer-1",
        canContribute: false,
        createdAt: "2025-05-01T00:00:00.000Z",
        user: {
          id: "viewer-1",
          name: "Jamie Viewer",
          email: "viewer@example.com",
        },
      },
    ];

    let resolveToggle: ((value: Response) => void) | null = null;
    const togglePromise = new Promise<Response>((resolve) => {
      resolveToggle = resolve;
    });

    const fetchMock = vi
      .fn()
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: {
              id: "trip-1",
              title: "Italy Highlights",
              startDate: "2025-05-01T00:00:00.000Z",
              endDate: "2025-05-10T00:00:00.000Z",
              coverImageUrl: null,
            },
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: [],
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(new Response(null, { status: 404 }))
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: viewersResponse,
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: [],
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockImplementationOnce(() => togglePromise);

    vi.stubGlobal("fetch", fetchMock);

    renderWithProvider(<TripDetail tripId="trip-1" canAddEntry canEditTrip canDeleteTrip canManageShare canManageViewers />);

    fireEvent.click(
      await screen.findByRole("button", { name: /share trip/i }),
    );

    await screen.findByText("Jamie Viewer");
    expect(screen.getByText(/view only/i)).toBeInTheDocument();

    fireEvent.click(
      screen.getByRole("button", { name: /enable contribution/i }),
    );

    const viewerName = await screen.findByText("Jamie Viewer");
    const viewerRow = viewerName.closest("li");
    expect(viewerRow).not.toBeNull();
    if (viewerRow) {
      expect(within(viewerRow).getByText("Contributor")).toBeInTheDocument();
    }

    resolveToggle?.(
      new Response(
        JSON.stringify({
          data: {
            ...viewersResponse[0],
            canContribute: true,
          },
          error: null,
        }),
        { status: 200 },
      ),
    );

    await waitFor(() => {
      const refreshedViewer = screen.getByText("Jamie Viewer");
      const refreshedRow = refreshedViewer.closest("li");
      expect(refreshedRow).not.toBeNull();
      if (refreshedRow) {
        expect(within(refreshedRow).getByText("Contributor")).toBeInTheDocument();
      }
    });
  });

  it("shows contributor toggle errors and reverts state", async () => {
    const viewersResponse = [
      {
        id: "access-1",
        tripId: "trip-1",
        userId: "viewer-1",
        canContribute: false,
        createdAt: "2025-05-01T00:00:00.000Z",
        user: {
          id: "viewer-1",
          name: "Jamie Viewer",
          email: "viewer@example.com",
        },
      },
    ];

    const fetchMock = vi
      .fn()
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: {
              id: "trip-1",
              title: "Italy Highlights",
              startDate: "2025-05-01T00:00:00.000Z",
              endDate: "2025-05-10T00:00:00.000Z",
              coverImageUrl: null,
            },
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: [],
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(new Response(null, { status: 404 }))
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: viewersResponse,
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: [],
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: null,
            error: {
              code: "INTERNAL_SERVER_ERROR",
              message: "Unable to update contributor access.",
            },
          }),
          { status: 500 },
        ),
      );

    vi.stubGlobal("fetch", fetchMock);

    renderWithProvider(<TripDetail tripId="trip-1" canAddEntry canEditTrip canDeleteTrip canManageShare canManageViewers />);

    fireEvent.click(
      await screen.findByRole("button", { name: /share trip/i }),
    );

    await screen.findByText("Jamie Viewer");
    fireEvent.click(
      screen.getByRole("button", { name: /enable contribution/i }),
    );

    await screen.findByText("Unable to update contributor access.");
    expect(screen.getByText(/view only/i)).toBeInTheDocument();
  });

  it("shows invite errors inline", async () => {
    const eligibleResponse = [
      {
        id: "viewer-1",
        name: "Jamie Viewer",
        email: "viewer@example.com",
        role: "viewer",
        createdAt: "2025-05-01T00:00:00.000Z",
        updatedAt: "2025-05-01T00:00:00.000Z",
      },
    ];
    const fetchMock = vi
      .fn()
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: {
              id: "trip-1",
              title: "Italy Highlights",
              startDate: "2025-05-01T00:00:00.000Z",
              endDate: "2025-05-10T00:00:00.000Z",
              coverImageUrl: null,
            },
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: [],
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(new Response(null, { status: 404 }))
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: [],
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: eligibleResponse,
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: null,
            error: {
              code: "NOT_FOUND",
              message: "User not found.",
            },
          }),
          { status: 404 },
        ),
      );

    vi.stubGlobal("fetch", fetchMock);

    renderWithProvider(<TripDetail tripId="trip-1" canAddEntry canEditTrip canDeleteTrip canManageShare canManageViewers />);

    const shareTrigger = await screen.findByRole("button", {
      name: /share trip/i,
    });
    fireEvent.click(shareTrigger);

    const inviteSelect = await screen.findByLabelText("Invite viewer selector");
    fireEvent.click(inviteSelect);
    const inviteOption = await screen.findByRole("option", {
      name: /jamie viewer/i,
    });
    fireEvent.click(inviteOption);

    fireEvent.click(screen.getByRole("button", { name: /^invite$/i }));

    await screen.findByText("User not found.");
  });

  it("filters already invited users out of the selector", async () => {
    const fetchMock = vi
      .fn()
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: {
              id: "trip-1",
              title: "Italy Highlights",
              startDate: "2025-05-01T00:00:00.000Z",
              endDate: "2025-05-10T00:00:00.000Z",
              coverImageUrl: null,
            },
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: [],
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(new Response(null, { status: 404 }))
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: [
              {
                id: "access-1",
                tripId: "trip-1",
                userId: "viewer-1",
                canContribute: false,
                createdAt: "2025-05-01T00:00:00.000Z",
                user: {
                  id: "viewer-1",
                  name: "Jamie Viewer",
                  email: "viewer@example.com",
                },
              },
            ],
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: [
              {
                id: "viewer-1",
                name: "Jamie Viewer",
                email: "viewer@example.com",
                role: "viewer",
                createdAt: "2025-05-01T00:00:00.000Z",
                updatedAt: "2025-05-01T00:00:00.000Z",
              },
              {
                id: "viewer-2",
                name: "Riley Guest",
                email: "riley@example.com",
                role: "viewer",
                createdAt: "2025-05-02T00:00:00.000Z",
                updatedAt: "2025-05-02T00:00:00.000Z",
              },
            ],
            error: null,
          }),
          { status: 200 },
        ),
      );

    vi.stubGlobal("fetch", fetchMock);

    renderWithProvider(<TripDetail tripId="trip-1" canAddEntry canEditTrip canDeleteTrip canManageShare canManageViewers />);

    const shareTrigger = await screen.findByRole("button", {
      name: /share trip/i,
    });
    fireEvent.click(shareTrigger);

    const inviteSelect = await screen.findByLabelText("Invite viewer selector");
    fireEvent.click(inviteSelect);
    expect(
      screen.queryByRole("option", { name: /viewer@example.com/i }),
    ).toBeNull();
    expect(
      screen.getByRole("option", { name: /riley@example.com/i }),
    ).toBeInTheDocument();
  });

  it("removes invited users with confirmation", async () => {
    const fetchMock = vi
      .fn()
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: {
              id: "trip-1",
              title: "Italy Highlights",
              startDate: "2025-05-01T00:00:00.000Z",
              endDate: "2025-05-10T00:00:00.000Z",
              coverImageUrl: null,
            },
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: [],
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(new Response(null, { status: 404 }))
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: [
              {
                id: "access-1",
                tripId: "trip-1",
                userId: "viewer-1",
                canContribute: false,
                createdAt: "2025-05-01T00:00:00.000Z",
                user: {
                  id: "viewer-1",
                  name: "Jamie Viewer",
                  email: "viewer@example.com",
                },
              },
            ],
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: [],
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: {
              id: "access-1",
              tripId: "trip-1",
              userId: "viewer-1",
              canContribute: false,
              createdAt: "2025-05-01T00:00:00.000Z",
              user: {
                id: "viewer-1",
                name: "Jamie Viewer",
                email: "viewer@example.com",
              },
            },
            error: null,
          }),
          { status: 200 },
        ),
      )
      .mockResolvedValueOnce(
        new Response(
          JSON.stringify({
            data: [
              {
                id: "viewer-1",
                name: "Jamie Viewer",
                email: "viewer@example.com",
                role: "viewer",
                createdAt: "2025-05-01T00:00:00.000Z",
                updatedAt: "2025-05-01T00:00:00.000Z",
              },
            ],
            error: null,
          }),
          { status: 200 },
        ),
      );

    vi.stubGlobal("fetch", fetchMock);

    renderWithProvider(<TripDetail tripId="trip-1" canAddEntry canEditTrip canDeleteTrip canManageShare canManageViewers />);

    const shareTrigger = await screen.findByRole("button", {
      name: /share trip/i,
    });
    fireEvent.click(shareTrigger);

    await screen.findByText("Jamie Viewer");
    fireEvent.click(screen.getByRole("button", { name: /remove/i }));
    fireEvent.click(screen.getByRole("button", { name: /yes, remove/i }));

    await waitFor(() => {
      expect(screen.queryByText("Jamie Viewer")).toBeNull();
    });
  });
});
